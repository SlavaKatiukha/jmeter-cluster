---
jpsType: install
jpsVersion: '1.1'
name: Jmeter Cluster
categories:
  - apps/popular
  - apps/clusters
  - apps/dev-and-admin-tools
description: Jmeter Cluster.
logo: https://raw.githubusercontent.com/jelastic-jps/wordpress-cluster/master/images/wp-cluster.png
baseUrl: https://raw.githubusercontent.com/sych74/jmeter-cluster/master

globals:
  OUTPUT_DIR: /var/www/webroot/ROOT
  TEST_PLAN: ${settings.host}_${settings.threadCount}_${settings.duration}
  LOG: /tmp/autotests.log

nodes:
  - nodeType: nginxphp
    cloudlets: 8
    nodeGroup: cp
    nodeGroupData:
      validation:
        maxCount: 1
    links: worker:worker
    addons: options
    displayName: Master

  - nodeType: javaengine
    tag: jdk-9.0.4
    cloudlets: 16
    nodeGroup: workers
    metadata:
      layer: workers
    displayName: Workers

settings:
    fields:
    - name: host
      caption: Host
      type: string
      inputType: string
      default: example.com
      regex: "^(?:http(s)?://)?[\\w.-]+(?:\\.[\\w\\.-]+)+[\\w\\-\\._~:/?#[\\]@!\\$&'\\(\\)\\*\\+,;=.]+$"
      regexText: 'Incorrect Link (example: http(s)://example.com/)'
      required: true
    - name: protocol
      caption: Protocol
      type: string
      inputType: string
      default: http
      required: true
    - name: threadCount
      caption: Thread Count (VU)
      type: string
      inputType: string
      default: 10
      required: true
    - name: duration
      caption: Test Duration in sec
      type: string
      inputType: string
      default: 300
      required: true
    - name: rampup
      caption: RamPUP
      type: string
      inputType: string
      default: 60
      required: true
    - type: string
      inputType: text
      name: email
      caption: Report to
      placeholder: Your@email.com
      required: true
      default: "${user.email}"

addons:
  - id: options
    buttons:
    - procedure: runTests
      caption: Run tests
      logsPath: "${globals.LOG}"
      successText: Autotests are launched.
    - procedure: stopTests
      caption: Stop tests
      logsPath: "${globals.LOG}"
      successText: Autotests are stopped
    - settings: main
      procedure: setConfig
      caption: Change Test Plan
      logsPath: "${globals.LOG}"
      submitButtonText: Apply
      successText: Test plan is successfully applied.

onInstall:  
  - script[cp,workers]: "${baseUrl}/scripts/firewallRules.js"
    ports: '1099'
    name: Jmeter

  - cmd[cp]: yum install java-1.8.0-openjdk -y
    user: root

  - cmd[cp]: |-
      rm -rf ${globals.OUTPUT_DIR}/*
      wget ${baseUrl}/configs/nginx.conf -O /etc/nginx/nginx.conf
      sudo /etc/init.d/nginx restart

  - cmd[cp,workers]: |-
      wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-3.3.zip -O /tmp/apache-jmeter.zip
      unzip -q /tmp/apache-jmeter.zip; mv ~/apache-jmeter-3.3/ ~/apache-jmeter
      sed -i "s/^CURRENT_VERSION.*/CURRENT_VERSION=1.8.0/g" ~/apache-jmeter/bin/jmeter
    
  - setupRemoteHosts
  
  - forEach(i:nodes.workers):
      - setupRMIHost:
          id: "${@i.id}"
      - setupOPTSjava:
          id: "${@i.id}"

  - cmd[cp]:
    - wget ${baseUrl}/configs/basic_test_plan.jmx.template -O ~/basic_test_plan.jmx.template

actions:
  setupRemoteHosts:
    script: |
      var resp = jelastic.env.control.GetEnvInfo('${env.envName}', session);
      if (resp.result != 0) return resp;
      var nodes = [];
      for (var i = 0, n = resp.nodes; i < n.length; i++)
        n[i].nodeGroup == nodeGroup ? nodes.push('node' + n[i].id + ':1099') : 0
      resp = {result:0, onAfterReturn: {}};
      resp.onAfterReturn['cmd['+ targetNode +']'] = 'sed -i "s/^remote_hosts.*/remote_hosts = '+ nodes.join(',') +'/" ~/apache-jmeter/bin/jmeter.properties';
      return resp;
    nodeGroup: workers
    targetNode: cp
  
  setupRMIHost:
    cmd[${this.id}]: |-
      sed -i "s/^\#RMI_HOST_DEF.*/RMI_HOST_DEF=-Djava.rmi.server.hostname=node${this.id}-${env.domain}/g" ~/apache-jmeter/bin/jmeter-server
      sed -i "s/^\#server.rmi.localport.*/server.rmi.localport=4000/g" ~/apache-jmeter/bin/jmeter.properties    

  setupOPTSjava:
    cmd[${this.id}]: |-
      sed -i "s/^JMETER_OPTS.*/JMETER_OPTS=\"-Djava.net.preferIPv4Stack=true\"/g" ~/apache-jmeter/bin/jmeter
      sed -i "s/^HEAP=.*/HEAP=\"-Xms1024m -Xmx1024m\"/g" ~/apache-jmeter/bin/jmeter

  runTests:
    - stopTests
    - cmd[workers]: bash /home/jelastic/apache-jmeter/bin/jmeter-server & >> ${globals.LOG}
    - cmd[cp]: bash ~/apache-jmeter/bin/jmeter -n -r -t ~/${globals.TEST_PLAN}/TEST_PLAN.jmx -l ~/${globals.TEST_PLAN}/TEST_OUTPUT.csv -e -o ${globals.OUTPUT_DIR}/${globals.TEST_PLAN} >> ${globals.LOG}

  stopTests:
    cmd [cp,workers]:
      - pkill jmeter >> ${globals.LOG}
      - pkill java >> ${globals.LOG}
      - echo 'Tests are stopped' >> ${globals.LOG}
  setConfig:
    cmd [cp]: |-
      mkdir -p ~/${globals.TEST_PLAN}
      cp ~/basic_test_plan.jmx.template ~/${globals.TEST_PLAN}/TEST_PLAN.jmx
      sed -i "s/_HOST_/${settings.host}/g" ~/${globals.TEST_PLAN}/TEST_PLAN.jmx
      sed -i "s/_PROTOCOL_/${settings.protocol}/g" ~/${globals.TEST_PLAN}/TEST_PLAN.jmx
      sed -i "s/_NUM_THREADS_/${settings.threadCount}/g" ~/${globals.TEST_PLAN}/TEST_PLAN.jmx
      sed -i "s/_RAMP_TIME_/${settings.rampup}/g" ~/${globals.TEST_PLAN}/TEST_PLAN.jmx
      sed -i "s/_DURATION_/${settings.duration}/g" ~/${globals.TEST_PLAN}/TEST_PLAN.jmx
      sed -i "s/_PATH_/\//g" ~/${globals.TEST_PLAN}/TEST_PLAN.jmx
